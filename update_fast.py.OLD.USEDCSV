#!/usr/bin/env python3
"""
Fast Deep Analysis Report Update - Uses Cached Historical Data
CRITICAL: Campaign IDs are ALWAYS replaced with STATE names in tables
Queries database ONLY for today's new data - FAST and safe!
"""

import pymysql
import csv
import os
from datetime import datetime, timedelta
from collections import defaultdict

# Database credentials
DB_HOST = "67.198.205.116"
DB_NAME = "asterisk"
DB_USER = "cron"
DB_PASS = "byt3w0rt4"
DB_PORT = 3306

# Map transfer campaigns to original states (for closer_log sales)
# NOTE: LiveXfer is NOT in this list - it's a MIXED campaign handled separately by area code
XFER_CAMPAIGN_STATES = {
    'GeorgiaXfer': 'GA',
    'StLouisXfer': 'MO',
    'StLouisXfer_FO': 'MO',
    'IllinoisXfer': 'IL',
    'IllinoisXferFailover': 'IL',
    'ColumbusCallback': 'OH',
}

def get_area_code_to_state_map():
    """Map area codes to US states"""
    return {
        # California
        '213': 'CA', '310': 'CA', '323': 'CA', '408': 'CA', '415': 'CA', '510': 'CA', '562': 'CA', '619': 'CA', '626': 'CA', '650': 'CA',
        '661': 'CA', '707': 'CA', '714': 'CA', '760': 'CA', '805': 'CA', '818': 'CA', '831': 'CA', '858': 'CA', '909': 'CA', '916': 'CA',
        '925': 'CA', '949': 'CA', '951': 'CA',
        # Texas
        '210': 'TX', '214': 'TX', '254': 'TX', '281': 'TX', '325': 'TX', '361': 'TX', '409': 'TX', '430': 'TX', '432': 'TX', '469': 'TX',
        '512': 'TX', '682': 'TX', '713': 'TX', '737': 'TX', '806': 'TX', '817': 'TX', '830': 'TX', '832': 'TX', '903': 'TX', '915': 'TX',
        '936': 'TX', '940': 'TX', '956': 'TX', '972': 'TX', '979': 'TX',
        # Florida
        '239': 'FL', '305': 'FL', '321': 'FL', '352': 'FL', '386': 'FL', '407': 'FL', '561': 'FL', '727': 'FL', '754': 'FL', '772': 'FL',
        '786': 'FL', '813': 'FL', '850': 'FL', '863': 'FL', '904': 'FL', '941': 'FL', '954': 'FL',
        # New York
        '212': 'NY', '315': 'NY', '347': 'NY', '516': 'NY', '518': 'NY', '585': 'NY', '607': 'NY', '631': 'NY', '646': 'NY', '716': 'NY',
        '718': 'NY', '845': 'NY', '914': 'NY', '917': 'NY', '929': 'NY',
        # Pennsylvania
        '215': 'PA', '267': 'PA', '272': 'PA', '412': 'PA', '484': 'PA', '570': 'PA', '610': 'PA', '717': 'PA', '724': 'PA', '814': 'PA',
        '878': 'PA',
        # Illinois
        '217': 'IL', '224': 'IL', '309': 'IL', '312': 'IL', '331': 'IL', '618': 'IL', '630': 'IL', '708': 'IL', '773': 'IL', '815': 'IL',
        '847': 'IL', '872': 'IL',
        # Ohio
        '216': 'OH', '220': 'OH', '234': 'OH', '330': 'OH', '380': 'OH', '419': 'OH', '440': 'OH', '513': 'OH', '567': 'OH', '614': 'OH',
        '740': 'OH', '937': 'OH',
        # Georgia
        '229': 'GA', '404': 'GA', '470': 'GA', '478': 'GA', '678': 'GA', '706': 'GA', '762': 'GA', '770': 'GA', '912': 'GA',
        # North Carolina
        '252': 'NC', '336': 'NC', '704': 'NC', '828': 'NC', '910': 'NC', '919': 'NC', '980': 'NC', '984': 'NC',
        # Michigan
        '231': 'MI', '248': 'MI', '269': 'MI', '313': 'MI', '517': 'MI', '586': 'MI', '616': 'MI', '734': 'MI', '810': 'MI', '906': 'MI',
        '947': 'MI', '989': 'MI',
        # New Jersey
        '201': 'NJ', '551': 'NJ', '609': 'NJ', '732': 'NJ', '848': 'NJ', '856': 'NJ', '862': 'NJ', '908': 'NJ', '973': 'NJ',
        # Virginia
        '276': 'VA', '434': 'VA', '540': 'VA', '571': 'VA', '703': 'VA', '757': 'VA', '804': 'VA',
        # Washington
        '206': 'WA', '253': 'WA', '360': 'WA', '425': 'WA', '509': 'WA', '564': 'WA',
        # Massachusetts
        '339': 'MA', '351': 'MA', '413': 'MA', '508': 'MA', '617': 'MA', '774': 'MA', '781': 'MA', '857': 'MA', '978': 'MA',
        # Arizona
        '480': 'AZ', '520': 'AZ', '602': 'AZ', '623': 'AZ', '928': 'AZ',
        # Tennessee
        '423': 'TN', '615': 'TN', '629': 'TN', '731': 'TN', '865': 'TN', '901': 'TN', '931': 'TN',
        # Indiana
        '219': 'IN', '260': 'IN', '317': 'IN', '574': 'IN', '765': 'IN', '812': 'IN',
        # Missouri
        '314': 'MO', '417': 'MO', '573': 'MO', '636': 'MO', '660': 'MO', '816': 'MO',
        # Maryland
        '240': 'MD', '301': 'MD', '410': 'MD', '443': 'MD', '667': 'MD',
        # Wisconsin
        '262': 'WI', '414': 'WI', '534': 'WI', '608': 'WI', '715': 'WI', '920': 'WI',
        # Colorado
        '303': 'CO', '719': 'CO', '720': 'CO', '970': 'CO',
        # Minnesota
        '218': 'MN', '320': 'MN', '507': 'MN', '612': 'MN', '651': 'MN', '763': 'MN', '952': 'MN',
        # South Carolina
        '803': 'SC', '843': 'SC', '854': 'SC', '864': 'SC',
        # Alabama
        '205': 'AL', '251': 'AL', '256': 'AL', '334': 'AL', '938': 'AL',
        # Louisiana
        '225': 'LA', '318': 'LA', '337': 'LA', '504': 'LA', '985': 'LA',
        # Kentucky
        '270': 'KY', '364': 'KY', '502': 'KY', '606': 'KY', '859': 'KY',
        # Oregon
        '458': 'OR', '503': 'OR', '541': 'OR', '971': 'OR',
        # Oklahoma
        '405': 'OK', '539': 'OK', '580': 'OK', '918': 'OK',
        # Connecticut
        '203': 'CT', '475': 'CT', '860': 'CT', '959': 'CT',
        # Iowa
        '319': 'IA', '515': 'IA', '563': 'IA', '641': 'IA', '712': 'IA',
        # Mississippi
        '228': 'MS', '601': 'MS', '662': 'MS', '769': 'MS',
        # Arkansas
        '479': 'AR', '501': 'AR', '870': 'AR',
        # Kansas
        '316': 'KS', '620': 'KS', '785': 'KS', '913': 'KS',
        # Utah
        '385': 'UT', '435': 'UT', '801': 'UT',
        # Nevada
        '702': 'NV', '725': 'NV', '775': 'NV',
        # New Mexico
        '505': 'NM', '575': 'NM',
        # Nebraska
        '308': 'NE', '402': 'NE', '531': 'NE',
        # West Virginia
        '304': 'WV', '681': 'WV',
        # Idaho
        '208': 'ID', '986': 'ID',
        # Hawaii
        '808': 'HI',
        # Maine
        '207': 'ME',
        # New Hampshire
        '603': 'NH',
        # Rhode Island
        '401': 'RI',
        # Montana
        '406': 'MT',
        # Delaware
        '302': 'DE',
        # South Dakota
        '605': 'SD',
        # North Dakota
        '701': 'ND',
        # Alaska
        '907': 'AK',
        # Vermont
        '802': 'VT',
        # Wyoming
        '307': 'WY',
    }

print("ðŸ”„ Starting fast daily update...")

# Load historical data from CSV
historical_file = "historical_data.csv"
if not os.path.exists(historical_file):
    print(f"âŒ ERROR: {historical_file} not found!")
    print("   Run: python3 export_historical_data.py first")
    exit(1)

print(f"ðŸ“‚ Loading historical data from {historical_file}...")
area_code_map = get_area_code_to_state_map()

# Build campaign to state mapping from historical data
campaign_states = {}
campaign_state_counts = defaultdict(lambda: defaultdict(int))

with open(historical_file, 'r') as f:
    reader = csv.DictReader(f)
    for row in reader:
        campaign_id = row['campaign_id']
        area_code = row['area_code']
        call_count = int(row['call_count'])

        state = area_code_map.get(area_code, 'UNKNOWN')
        if state != 'UNKNOWN':
            campaign_state_counts[campaign_id][state] += call_count

# Determine dominant state for each campaign
for campaign_id, state_counts in campaign_state_counts.items():
    if state_counts:
        dominant_state = max(state_counts, key=state_counts.get)
        campaign_states[campaign_id] = dominant_state

print(f"âœ… Loaded {len(campaign_states)} campaigns with state mappings")

# Query database ONLY for today's new data (FAST!)
print("ðŸ“Š Querying database for TODAY's data only (fast & safe)...")

conn = pymysql.connect(
    host=DB_HOST,
    user=DB_USER,
    password=DB_PASS,
    database=DB_NAME,
    port=DB_PORT,
    connect_timeout=10
)

cursor = conn.cursor(pymysql.cursors.DictCursor)

optin_statuses = "('SVYCLM')"
sale_statuses = "('SALE')"

# Today's stats by campaign - Index-friendly range query
cursor.execute(f"""
SELECT
    campaign_id,
    SUBSTRING(phone_number, 1, 3) as area_code,
    status,
    COUNT(*) as call_count
FROM vicidial_log
WHERE call_date >= CURDATE() AND call_date < CURDATE() + INTERVAL 1 DAY
GROUP BY campaign_id, area_code, status
""")
today_data = cursor.fetchall()

# Yesterday's stats - Index-friendly range query
cursor.execute(f"""
SELECT
    campaign_id,
    SUBSTRING(phone_number, 1, 3) as area_code,
    status,
    COUNT(*) as call_count
FROM vicidial_log
WHERE call_date >= DATE_SUB(CURDATE(), INTERVAL 1 DAY) AND call_date < CURDATE()
GROUP BY campaign_id, area_code, status
""")
yesterday_data = cursor.fetchall()

# Current month stats (NO SALES from vicidial_log)
current_month = datetime.now().strftime('%Y-%m')
cursor.execute(f"""
SELECT
    COUNT(*) as total_calls,
    SUM(CASE WHEN status IN {optin_statuses} THEN 1 ELSE 0 END) as opt_ins
FROM vicidial_log
WHERE DATE_FORMAT(call_date, '%Y-%m') = '{current_month}'
""")
current_month_stats = cursor.fetchone()

# Previous month stats (NO SALES from vicidial_log)
previous_month = (datetime.now().replace(day=1) - timedelta(days=1)).strftime('%Y-%m')
cursor.execute(f"""
SELECT
    COUNT(*) as total_calls,
    SUM(CASE WHEN status IN {optin_statuses} THEN 1 ELSE 0 END) as opt_ins
FROM vicidial_log
WHERE DATE_FORMAT(call_date, '%Y-%m') = '{previous_month}'
""")
previous_month_stats = cursor.fetchone()

# 14-day daily stats - Keep DATE() in SELECT but use range in WHERE (NO SALES from vicidial_log)
cursor.execute(f"""
SELECT
    DATE(call_date) as call_day,
    COUNT(*) as total_calls,
    SUM(CASE WHEN status IN {optin_statuses} THEN 1 ELSE 0 END) as opt_ins
FROM vicidial_log
WHERE call_date >= DATE_SUB(CURDATE(), INTERVAL 14 DAY)
GROUP BY DATE(call_date)
ORDER BY call_day DESC
LIMIT 14
""")
fourteen_day_stats = cursor.fetchall()

cursor.close()
conn.close()

print("âœ… Database queries complete!")

# Process today's data by state AND by campaign+state
optin_list = ['SVYCLM']
today_by_state = defaultdict(lambda: {'calls': 0, 'optins': 0, 'sales': 0})
today_by_campaign = defaultdict(lambda: defaultdict(lambda: {'calls': 0, 'optins': 0, 'sales': 0}))

for row in today_data:
    campaign_id = row['campaign_id']
    area_code = row['area_code']
    status = row['status']
    count = row['call_count']

    state = area_code_map.get(area_code, 'UNKNOWN')
    if state != 'UNKNOWN':
        # Keep old state aggregation for totals
        today_by_state[state]['calls'] += count
        if status in optin_list:
            today_by_state[state]['optins'] += count
        # NO LONGER COUNT SALES FROM vicidial_log - only closer_log

        # NEW: Also track by campaign + state
        today_by_campaign[campaign_id][state]['calls'] += count
        if status in optin_list:
            today_by_campaign[campaign_id][state]['optins'] += count
        # NO LONGER COUNT SALES FROM vicidial_log - only closer_log

# Process yesterday's data by state AND by campaign+state
yesterday_by_state = defaultdict(lambda: {'calls': 0, 'optins': 0, 'sales': 0})
yesterday_by_campaign = defaultdict(lambda: defaultdict(lambda: {'calls': 0, 'optins': 0, 'sales': 0}))

for row in yesterday_data:
    campaign_id = row['campaign_id']
    area_code = row['area_code']
    status = row['status']
    count = row['call_count']

    state = area_code_map.get(area_code, 'UNKNOWN')
    if state != 'UNKNOWN':
        # Keep old state aggregation for totals
        yesterday_by_state[state]['calls'] += count
        if status in optin_list:
            yesterday_by_state[state]['optins'] += count
        # NO LONGER COUNT SALES FROM vicidial_log - only closer_log

        # Also track by campaign + state
        yesterday_by_campaign[campaign_id][state]['calls'] += count
        if status in optin_list:
            yesterday_by_campaign[campaign_id][state]['optins'] += count
        # NO LONGER COUNT SALES FROM vicidial_log - only closer_log

# Query closer_log for SALES (transferred calls) for today and yesterday
print("ðŸ“Š Querying vicidial_closer_log for sales...")

# Reopen connection for closer_log queries
conn = pymysql.connect(
    host=DB_HOST,
    user=DB_USER,
    password=DB_PASS,
    database=DB_NAME,
    port=DB_PORT,
    connect_timeout=10
)
cursor = conn.cursor(pymysql.cursors.DictCursor)

# Today's closer_log sales
cursor.execute("""
SELECT campaign_id, COUNT(*) as cnt
FROM vicidial_closer_log
WHERE call_date >= CURDATE() AND call_date < CURDATE() + INTERVAL 1 DAY
AND status = 'SALE'
GROUP BY campaign_id
""")
today_closer_sales = cursor.fetchall()

for row in today_closer_sales:
    campaign_id = row['campaign_id']
    cnt = row['cnt']

    if campaign_id in XFER_CAMPAIGN_STATES:
        state = XFER_CAMPAIGN_STATES[campaign_id]
        today_by_state[state]['sales'] += cnt

        # Also add to campaign breakdown - find the original outbound campaign for this state
        for orig_campaign_id, campaign_state in campaign_states.items():
            if campaign_state == state:
                today_by_campaign[orig_campaign_id][state]['sales'] += cnt

# Yesterday's closer_log sales
cursor.execute("""
SELECT campaign_id, COUNT(*) as cnt
FROM vicidial_closer_log
WHERE call_date >= DATE_SUB(CURDATE(), INTERVAL 1 DAY) AND call_date < CURDATE()
AND status = 'SALE'
GROUP BY campaign_id
""")
yesterday_closer_sales = cursor.fetchall()

for row in yesterday_closer_sales:
    campaign_id = row['campaign_id']
    cnt = row['cnt']

    if campaign_id in XFER_CAMPAIGN_STATES:
        state = XFER_CAMPAIGN_STATES[campaign_id]
        yesterday_by_state[state]['sales'] += cnt

        # Also add to campaign breakdown - find the original outbound campaign for this state
        for orig_campaign_id, campaign_state in campaign_states.items():
            if campaign_state == state:
                yesterday_by_campaign[orig_campaign_id][state]['sales'] += cnt

# Get current month closer_log sales (excluding LiveXfer)
print("ðŸ“Š Querying current month closer_log sales...")
cursor.execute(f"""
SELECT COUNT(*) as cnt
FROM vicidial_closer_log
WHERE DATE_FORMAT(call_date, '%Y-%m') = '{current_month}'
AND status = 'SALE'
AND campaign_id IN ('GeorgiaXfer', 'StLouisXfer', 'StLouisXfer_FO', 'IllinoisXfer', 'IllinoisXferFailover', 'ColumbusCallback')
""")
current_month_closer_sales = cursor.fetchone()['cnt']

# Get previous month closer_log sales (excluding LiveXfer)
cursor.execute(f"""
SELECT COUNT(*) as cnt
FROM vicidial_closer_log
WHERE DATE_FORMAT(call_date, '%Y-%m') = '{previous_month}'
AND status = 'SALE'
AND campaign_id IN ('GeorgiaXfer', 'StLouisXfer', 'StLouisXfer_FO', 'IllinoisXfer', 'IllinoisXferFailover', 'ColumbusCallback')
""")
previous_month_closer_sales = cursor.fetchone()['cnt']

# Get 14-day closer_log sales (excluding LiveXfer)
print("ðŸ“Š Querying 14-day closer_log sales...")
cursor.execute("""
SELECT
    DATE(call_date) as call_day,
    COUNT(*) as cnt
FROM vicidial_closer_log
WHERE call_date >= DATE_SUB(CURDATE(), INTERVAL 14 DAY)
AND status = 'SALE'
AND campaign_id IN ('GeorgiaXfer', 'StLouisXfer', 'StLouisXfer_FO', 'IllinoisXfer', 'IllinoisXferFailover', 'ColumbusCallback')
GROUP BY DATE(call_day)
""")
fourteen_day_closer_sales = cursor.fetchall()

# Add sales to current/previous month stats
current_month_stats['sales'] = current_month_closer_sales
previous_month_stats['sales'] = previous_month_closer_sales

# LiveXfer is EXCLUDED from all sales counting per user request
print("âœ… Closer_log sales added (LiveXfer EXCLUDED)!")

cursor.close()
conn.close()

# Calculate today's totals
today_stats = {
    'total_calls': sum(s['calls'] for s in today_by_state.values()),
    'opt_ins': sum(s['optins'] for s in today_by_state.values()),
    'sales': sum(s['sales'] for s in today_by_state.values())
}

# Append today's data to historical CSV
print(f"ðŸ’¾ Appending today's data to {historical_file}...")
today_date = datetime.now().strftime('%Y-%m-%d')

with open(historical_file, 'a', newline='') as f:
    writer = csv.DictWriter(f, fieldnames=['date', 'campaign_id', 'area_code', 'status', 'call_count'])
    for row in today_data:
        writer.writerow({
            'date': today_date,
            'campaign_id': row['campaign_id'],
            'area_code': row['area_code'],
            'status': row['status'],
            'call_count': row['call_count']
        })

print("âœ… Historical data updated!")

# Generate HTML report
print("ðŸŽ¨ Generating HTML report...")

# Calculate rates
current_month_stats['optin_rate'] = (current_month_stats['opt_ins'] / current_month_stats['total_calls'] * 100) if current_month_stats['total_calls'] > 0 else 0
current_month_stats['sales_rate'] = (current_month_stats['sales'] / current_month_stats['total_calls'] * 100) if current_month_stats['total_calls'] > 0 else 0

previous_month_stats['optin_rate'] = (previous_month_stats['opt_ins'] / previous_month_stats['total_calls'] * 100) if previous_month_stats['total_calls'] > 0 else 0
previous_month_stats['sales_rate'] = (previous_month_stats['sales'] / previous_month_stats['total_calls'] * 100) if previous_month_stats['total_calls'] > 0 else 0

# Calculate projections
current_day_of_month = datetime.now().day
days_in_current_month = (datetime.now().replace(day=28) + timedelta(days=4)).replace(day=1) - timedelta(days=1)
total_days_in_month = days_in_current_month.day

if current_day_of_month > 0:
    daily_avg_calls = current_month_stats['total_calls'] / current_day_of_month
    daily_avg_optins = current_month_stats['opt_ins'] / current_day_of_month
    daily_avg_sales = current_month_stats['sales'] / current_day_of_month

    projected_calls = int(daily_avg_calls * total_days_in_month)
    projected_optins = int(daily_avg_optins * total_days_in_month)
    projected_sales = int(daily_avg_sales * total_days_in_month)
else:
    projected_calls = current_month_stats['total_calls']
    projected_optins = current_month_stats['opt_ins']
    projected_sales = current_month_stats['sales']

# Calculate changes
calls_change = ((projected_calls - previous_month_stats['total_calls']) / previous_month_stats['total_calls'] * 100) if previous_month_stats['total_calls'] > 0 else 0
optins_change = ((projected_optins - previous_month_stats['opt_ins']) / previous_month_stats['opt_ins'] * 100) if previous_month_stats['opt_ins'] > 0 else 0
sales_change = ((projected_sales - previous_month_stats['sales']) / previous_month_stats['sales'] * 100) if previous_month_stats['sales'] > 0 else 0

# Generate TODAY's campaign-based table (campaigns -> states)
today_market_rows = ""
for campaign_id in sorted(today_by_campaign.keys()):
    states_data = today_by_campaign[campaign_id]

    # Calculate campaign totals
    campaign_total_calls = sum(s['calls'] for s in states_data.values())
    campaign_total_optins = sum(s['optins'] for s in states_data.values())
    campaign_total_sales = sum(s['sales'] for s in states_data.values())

    if campaign_total_optins > 0:
        campaign_calls_per_optin = campaign_total_calls / campaign_total_optins
        campaign_optin_rate = (campaign_total_optins / campaign_total_calls * 100) if campaign_total_calls > 0 else 0

        # Format opt-ins per sale
        if campaign_total_sales > 0:
            campaign_optins_per_sale_str = f"{campaign_total_optins / campaign_total_sales:.1f}"
        else:
            campaign_optins_per_sale_str = "N/A"

        # Just show campaign total - no individual state rows
        campaign_state_name = campaign_states.get(campaign_id, 'UNKNOWN')
        today_market_rows += f"""
                <tr>
                    <td>ðŸ“Š {campaign_state_name}</td>
                    <td>{campaign_total_calls:,}</td>
                    <td>{campaign_total_optins:,}</td>
                    <td>{campaign_total_sales}</td>
                    <td>{campaign_optin_rate:.2f}%</td>
                    <td>{campaign_calls_per_optin:.0f}</td>
                    <td>{campaign_optins_per_sale_str}</td>
                </tr>"""

# Generate YESTERDAY's campaign-based table (campaigns -> states)
yesterday_market_rows = ""
for campaign_id in sorted(yesterday_by_campaign.keys()):
    states_data = yesterday_by_campaign[campaign_id]

    # Calculate campaign totals
    campaign_total_calls = sum(s['calls'] for s in states_data.values())
    campaign_total_optins = sum(s['optins'] for s in states_data.values())
    campaign_total_sales = sum(s['sales'] for s in states_data.values())

    if campaign_total_optins > 0:
        campaign_calls_per_optin = campaign_total_calls / campaign_total_optins
        campaign_optin_rate = (campaign_total_optins / campaign_total_calls * 100) if campaign_total_calls > 0 else 0

        # Format opt-ins per sale
        if campaign_total_sales > 0:
            campaign_optins_per_sale_str = f"{campaign_total_optins / campaign_total_sales:.1f}"
        else:
            campaign_optins_per_sale_str = "N/A"

        # Just show campaign total - no individual state rows
        campaign_state_name = campaign_states.get(campaign_id, 'UNKNOWN')
        yesterday_market_rows += f"""
                <tr>
                    <td>ðŸ“Š {campaign_state_name}</td>
                    <td>{campaign_total_calls:,}</td>
                    <td>{campaign_total_optins:,}</td>
                    <td>{campaign_total_sales}</td>
                    <td>{campaign_optin_rate:.2f}%</td>
                    <td>{campaign_calls_per_optin:.0f}</td>
                    <td>{campaign_optins_per_sale_str}</td>
                </tr>"""

# Add closer_log sales to 14-day stats
closer_sales_by_date = {}
for row in fourteen_day_closer_sales:
    date_str = str(row['call_day'])
    closer_sales_by_date[date_str] = row['cnt']

# Add sales field to fourteen_day_stats from closer_log
for day_stat in fourteen_day_stats:
    date_str = str(day_stat['call_day'])
    day_stat['sales'] = closer_sales_by_date.get(date_str, 0)

# Generate 14-day table
fourteen_day_rows = ""
for day_stat in fourteen_day_stats:
    day = day_stat['call_day']
    calls = day_stat['total_calls']
    optins = day_stat['opt_ins']
    sales = day_stat['sales']
    optin_rate = (optins / calls * 100) if calls > 0 else 0
    calls_per_optin = calls / optins if optins > 0 else 0
    day_name = day.strftime('%a')

    fourteen_day_rows += f"""
                <tr>
                    <td>{day.strftime('%Y-%m-%d')}</td>
                    <td>{day_name}</td>
                    <td>{calls:,}</td>
                    <td>{optins:,}</td>
                    <td>{sales}</td>
                    <td>{optin_rate:.3f}%</td>
                    <td>{calls_per_optin:.0f}</td>
                </tr>"""

# Calculate 14-day totals
total_14day_calls = sum(d['total_calls'] for d in fourteen_day_stats)
total_14day_optins = sum(d['opt_ins'] for d in fourteen_day_stats)
total_14day_sales = sum(d['sales'] for d in fourteen_day_stats)
avg_14day_calls = total_14day_calls / len(fourteen_day_stats) if fourteen_day_stats else 0
avg_14day_optins = total_14day_optins / len(fourteen_day_stats) if fourteen_day_stats else 0
avg_optin_rate_14day = (total_14day_optins / total_14day_calls * 100) if total_14day_calls > 0 else 0

# Get month names
current_month_name = datetime.now().strftime('%B %Y')
previous_month_name = (datetime.now().replace(day=1) - timedelta(days=1)).strftime('%B %Y')

# Generate HTML
html = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Analysis - {current_month_name} Performance Review</title>
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}

        body {{
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #000;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }}

        .container {{ max-width: 1800px; margin: 0 auto; }}

        .header {{
            background: linear-gradient(135deg, #ff0080 0%, #7928ca 50%, #ff0080 100%);
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
            padding: 50px;
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: 0 10px 40px rgba(255, 0, 128, 0.3);
        }}

        @keyframes gradient {{
            0% {{ background-position: 0% 50%; }}
            50% {{ background-position: 100% 50%; }}
            100% {{ background-position: 0% 50%; }}
        }}

        .header h1 {{ font-size: 48px; font-weight: 900; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; }}
        .header .subtitle {{ font-size: 20px; opacity: 0.95; }}
        .header .date {{ font-size: 16px; opacity: 0.8; margin-top: 10px; }}

        .trend-box {{
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #ff0080;
            border-radius: 16px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(255, 0, 128, 0.2);
        }}

        .trend-box h2 {{
            font-size: 32px;
            margin-bottom: 20px;
            color: #ff0080;
            border-bottom: 3px solid #7928ca;
            padding-bottom: 15px;
        }}

        .metric-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }}

        .metric-card {{
            background: rgba(121, 40, 202, 0.1);
            border: 1px solid #7928ca;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }}

        .metric-card:hover {{
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 0, 128, 0.3);
        }}

        .metric-card .label {{
            font-size: 13px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }}

        .metric-card .value {{
            font-size: 42px;
            font-weight: 800;
            color: #ff0080;
        }}

        .metric-card .change {{
            font-size: 16px;
            margin-top: 10px;
            font-weight: 600;
        }}

        .metric-card .change.up {{ color: #00ff88; }}
        .metric-card .change.down {{ color: #ff4444; }}

        table {{
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }}

        th, td {{
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 0, 128, 0.2);
        }}

        th {{
            background: rgba(121, 40, 202, 0.3);
            color: #ff0080;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }}

        tr:hover {{
            background: rgba(121, 40, 202, 0.1);
        }}

        .footer {{
            text-align: center;
            margin-top: 50px;
            padding: 30px;
            border-top: 2px solid #ff0080;
            opacity: 0.7;
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”¥ DEEP ANALYSIS ðŸ”¥</h1>
            <div class="subtitle">Vicidial Performance Review - {current_month_name}</div>
            <div class="date">Generated: {datetime.now().strftime('%B %d, %Y at %I:%M %p')}</div>
        </div>

        <div class="trend-box">
            <h2>ðŸ“ž TODAY'S CAMPAIGN PERFORMANCE</h2>
            <p style="margin-bottom: 20px; opacity: 0.8;">Campaigns by state (most efficient first) - {datetime.now().strftime('%B %d, %Y')}</p>
            <table>
                <thead>
                    <tr>
                        <th>Campaign</th>
                        <th>Total Calls</th>
                        <th>Opt-ins</th>
                        <th>Sales</th>
                        <th>Opt-in Rate</th>
                        <th>Calls/Opt-in</th>
                        <th>Opt-ins/Sale</th>
                    </tr>
                </thead>
                <tbody>
                    {today_market_rows}
                </tbody>
            </table>
        </div>

        <div class="trend-box">
            <h2>ðŸ“ž YESTERDAY'S CAMPAIGN PERFORMANCE</h2>
            <p style="margin-bottom: 20px; opacity: 0.8;">Campaigns by state (most efficient first) - {(datetime.now() - timedelta(days=1)).strftime('%B %d, %Y')}</p>
            <table>
                <thead>
                    <tr>
                        <th>Campaign</th>
                        <th>Total Calls</th>
                        <th>Opt-ins</th>
                        <th>Sales</th>
                        <th>Opt-in Rate</th>
                        <th>Calls/Opt-in</th>
                        <th>Opt-ins/Sale</th>
                    </tr>
                </thead>
                <tbody>
                    {yesterday_market_rows}
                </tbody>
            </table>
        </div>

        <div class="trend-box">
            <h2>ðŸ“ˆ LAST 14 DAYS TREND</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="label">Total Calls (14 days)</div>
                    <div class="value">{total_14day_calls:,}</div>
                    <div class="change">Avg: {avg_14day_calls:,.0f}/day</div>
                </div>
                <div class="metric-card">
                    <div class="label">Total Opt-ins (14 days)</div>
                    <div class="value">{total_14day_optins:,}</div>
                    <div class="change">Avg: {avg_14day_optins:,.0f}/day</div>
                </div>
                <div class="metric-card">
                    <div class="label">Total Sales (14 days)</div>
                    <div class="value">{total_14day_sales:,}</div>
                </div>
                <div class="metric-card">
                    <div class="label">14-Day Opt-in Rate</div>
                    <div class="value">{avg_optin_rate_14day:.2f}%</div>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Calls</th>
                        <th>Opt-ins</th>
                        <th>Sales</th>
                        <th>Opt-in %</th>
                        <th>Calls/Opt-in</th>
                    </tr>
                </thead>
                <tbody>
                    {fourteen_day_rows}
                </tbody>
            </table>
        </div>

        <div class="trend-box">
            <h2>ðŸš€ {current_month_name.upper()} OVERVIEW</h2>
            <p style="margin-bottom: 20px; opacity: 0.8;">Day {current_day_of_month} of {total_days_in_month} | Projected full month based on current pace</p>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="label">Total Calls (Projected)</div>
                    <div class="value">{projected_calls:,}</div>
                    <div class="change {'up' if calls_change >= 0 else 'down'}">
                        {'+' if calls_change >= 0 else ''}{calls_change:.1f}% vs {previous_month_name}
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; opacity: 0.7;">MTD: {current_month_stats['total_calls']:,}</div>
                </div>
                <div class="metric-card">
                    <div class="label">Total Opt-ins (Projected)</div>
                    <div class="value">{projected_optins:,}</div>
                    <div class="change {'up' if optins_change >= 0 else 'down'}">
                        {'+' if optins_change >= 0 else ''}{optins_change:.1f}% vs {previous_month_name}
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; opacity: 0.7;">MTD: {current_month_stats['opt_ins']:,}</div>
                </div>
                <div class="metric-card">
                    <div class="label">Total Sales (Projected)</div>
                    <div class="value">{projected_sales:,}</div>
                    <div class="change {'up' if sales_change >= 0 else 'down'}">
                        {'+' if sales_change >= 0 else ''}{sales_change:.1f}% vs {previous_month_name}
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; opacity: 0.7;">MTD: {current_month_stats['sales']:,}</div>
                </div>
                <div class="metric-card">
                    <div class="label">Opt-in Rate</div>
                    <div class="value">{current_month_stats['optin_rate']:.1f}%</div>
                </div>
                <div class="metric-card">
                    <div class="label">Sales Close Rate</div>
                    <div class="value">{current_month_stats['sales_rate']:.1f}%</div>
                </div>
            </div>
        </div>

        <div class="trend-box">
            <h2>ðŸ“ˆ {previous_month_name.upper()} COMPARISON</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="label">Total Calls</div>
                    <div class="value">{previous_month_stats['total_calls']:,}</div>
                </div>
                <div class="metric-card">
                    <div class="label">Opt-ins</div>
                    <div class="value">{previous_month_stats['opt_ins']:,}</div>
                    <div class="change">{previous_month_stats['optin_rate']:.1f}% Rate</div>
                </div>
                <div class="metric-card">
                    <div class="label">Sales</div>
                    <div class="value">{previous_month_stats['sales']:,}</div>
                    <div class="change">{previous_month_stats['sales_rate']:.1f}% Rate</div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>ðŸ¤– Automated Deep Analysis Report</p>
            <p>Capital Energy Vicidial System</p>
            <p style="margin-top: 10px; font-size: 12px;">âš¡ Fast updates using cached historical data - Campaigns shown by state name</p>
        </div>
    </div>
</body>
</html>
"""

# Save
output_file = "deep-analysis.html"
with open(output_file, 'w') as f:
    f.write(html)

print(f"\nâœ… Report generated: {output_file}")
print(f"ðŸ“… Date: {datetime.now().strftime('%B %d, %Y at %I:%M %p')}")
print(f"ðŸ“Š Today's Calls: {today_stats['total_calls']:,}")
print(f"ðŸ“Š Today's Opt-ins: {today_stats['opt_ins']:,}")
print("\nðŸš€ Done! Run this daily after calls end - it's FAST and safe!")
